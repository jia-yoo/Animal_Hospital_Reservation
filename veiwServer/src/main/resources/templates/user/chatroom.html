<!DOCTYPE html>
<html class="h-100" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>견강할고양</title>
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link href="/css/style.css" rel="stylesheet">
<link href="/css/myPetList.css" rel="stylesheet">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Do+Hyeon&family=Jua&display=swap" rel="stylesheet">
</head>
 <style>
   #chat-box {
       border: 1px solid #ccc;
       height: 400px;
       overflow-y: scroll;
       margin-bottom: 20px;
       padding: 10px;
   }
   .message {
       padding: 5px;
       border-bottom: 1px solid #ccc;
   }
   .message:last-child {
       border-bottom: none;
   }
</style>
<body class="d-flex flex-column h-100">
<div th:replace="~{user/header :: header}"></div>
<div class="container-xl">


<h1 class="mt-3 mt-md-5 mb-3 mb-md-3">채팅방</h1>
<hr>

		<div class="container">
		    <h2 class="mt-3">1:1 채팅방</h2>
		    <div id="chat-box"></div>
		    <form id="chat-form">
		        <div class="form-group">
		            <input type="text" id="message" class="form-control" placeholder="Type your message...">
		        </div>
		        <div class="input-group-append">
		        <button type="submit" class="btn btn-outline-secondary">Send</button>
		        </div>
		        <div>
		        <button id="disconn" class="btn btn-outline-secondary">나가기</button>
		        </div>
		    </form>
		</div>



</div>

<div th:replace="~{user/footer :: footer}"></div>

<script th:inline="javascript">

const sender = localStorage.getItem('MemberId'); //사용자 username 불러오기
const receiver = "[[${id}]]"; //병원 username 불러오기

const socket = new WebSocket("ws://localhost:9001/ws/chat");

socket.onopen = function(event) {
    console.log("웹소켓 연결 성공!");
    socket.send(JSON.stringify({
        type: 'join',
        sender: sender,
        receiver: receiver,
        message : "채팅이 연결되었습니다."
    }));
};

socket.onmessage = function(event) {
    const message = JSON.parse(event.data);
    const messageElement = document.createElement('div');
    messageElement.className = 'message';
    messageElement.innerText =  message.message;
    document.getElementById('chat-box').appendChild(messageElement);
    console.log(message.sender + " :  message");
};


socket.onclose = function() {
    console.log("서버 연결 해제");
};


document.getElementById('chat-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const message = document.getElementById('message').value;
    socket.send(JSON.stringify({
        type: 'message',
        sender: sender,
        receiver: receiver,
        message: message
    }));
    document.getElementById('message').value = '';
});



</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>